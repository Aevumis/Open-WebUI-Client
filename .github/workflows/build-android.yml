name: Build Android APK

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        default: 'preview'
        type: choice
        options:
        - development
        - preview
        - production
        - production-apk

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: üèó Setup repo
      uses: actions/checkout@v4

    - name: üèó Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 18.x
        cache: npm

    - name: üèó Setup EAS
      uses: expo/expo-github-action@v8
      with:
        eas-version: latest
        token: ${{ secrets.EXPO_TOKEN }}

    - name: üîß Install jq
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: üì¶ Install dependencies
      run: npm ci

    - name: üöÄ Build app
      run: |
        # Determine build profile
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          PROFILE="${{ github.event.inputs.profile }}"
        elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
          PROFILE="production"
        else
          PROFILE="preview"
        fi
        
        echo "Building with profile: $PROFILE"
        echo "PROFILE=$PROFILE" >> $GITHUB_ENV
        # Start build and wait for completion; capture JSON result
        eas build --platform android --profile "$PROFILE" --non-interactive --wait --json > build.json
        echo "EAS build finished. Captured output to build.json"
        # Parse build id from either array or object shape
        BUILD_ID=$(jq -r '.[0].id // .id // empty' build.json)
        echo "Build ID: ${BUILD_ID}"
        echo "build_id=${BUILD_ID}" >> $GITHUB_OUTPUT
      id: build

    - name: üì± Download APK
      if: success()
      run: |
        # Resolve artifact URL and download APK
        ID=""
        if [ -f build.json ]; then
          ID=$(jq -r '.[0].id // .id // empty' build.json)
        fi
        if [ -z "$ID" ]; then
          echo "No build ID found in build.json; cannot download."
          exit 1
        fi
        echo "Fetching build details for $ID"
        eas build:view --non-interactive --json --id "$ID" > build_view.json
        URL=$(jq -r '.artifacts.buildUrl // .artifacts.applicationArchiveUrl // .artifacts.appBuildUrl // empty' build_view.json)
        if [ -z "$URL" ] || [ "$URL" = "null" ]; then
          echo "Could not resolve artifact URL from build_view.json"
          cat build_view.json
          exit 1
        fi
        echo "Resolved artifact URL: $URL"
        curl -L "$URL" -o ./app-build.apk

    - name: üìä Build Summary
      if: success()
      run: |
        echo "## üöÄ Build Completed Successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Profile:** ${PROFILE:-auto-detected}" >> $GITHUB_STEP_SUMMARY
        echo "**Platform:** Android" >> $GITHUB_STEP_SUMMARY
        echo "**Build ID:** ${{ steps.build.outputs.build_id }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Get APK size
        if [ -f "./app-build.apk" ]; then
          APK_SIZE=$(du -h ./app-build.apk | cut -f1)
          echo "**APK Size:** $APK_SIZE" >> $GITHUB_STEP_SUMMARY
        fi

    - name: üì¶ Upload APK Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-${{ github.run_number }}
        path: ./app-build.apk
        retention-days: 30

    - name: üí¨ Comment PR
      if: github.event_name == 'pull_request' && success()
      uses: actions/github-script@v7
      env:
        BUILD_ID: ${{ steps.build.outputs.build_id }}
        PROFILE: ${{ env.PROFILE }}
      with:
        script: |
          const fs = require('fs');
          const apkSize = fs.existsSync('./app-build.apk') 
            ? require('child_process').execSync('du -h ./app-build.apk').toString().split('\t')[0]
            : 'Unknown';
          const lines = [
            '## üì± Android Build Ready',
            '',
            '**Build completed successfully!**',
            `- **Profile:** ${process.env.PROFILE || 'auto-detected'}`,
            `- **APK Size:** ${apkSize}`,
            '- **Download:** Check the "Artifacts" section in this workflow run',
            `- **Build ID:** ${process.env.BUILD_ID}`,
            '',
            'You can download and test the APK from the workflow artifacts.'
          ];
          const bodyText = lines.join('\n');

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: bodyText
          });

  notify-failure:
    name: Notify Build Failure
    runs-on: ubuntu-latest
    needs: build
    if: failure()
    
    steps:
    - name: üí¨ Comment PR on Failure
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      env:
        COMMIT_SHA: ${{ github.sha }}
        RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      with:
        script: |
          const lines = [
            '## ‚ùå Android Build Failed',
            '',
            'The Android build failed for this PR. Please check the workflow logs for details.',
            '',
            '**Build Details:**',
            `- **Commit:** ${process.env.COMMIT_SHA}`,
            `- **Workflow:** [View logs](${process.env.RUN_URL})`,
            '',
            'Please fix the issues and push again to trigger a new build.'
          ];
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: lines.join('\n')
          });