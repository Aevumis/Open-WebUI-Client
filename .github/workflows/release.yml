name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    name: Build and Publish Release
    runs-on: ubuntu-latest
    env:
      EAS_NO_VCS: 1
    steps:
      - name: ðŸ—ï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ§° Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: ðŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸ§ª Validate tag and derive version
        run: |
          echo "GITHUB_REF=$GITHUB_REF"
          echo "GITHUB_REF_NAME=$GITHUB_REF_NAME"

          # Validate tag format
          if [[ ! "$GITHUB_REF_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Error: Invalid tag format. Expected vX.Y.Z (or vX.Y.Z-suffix), got $GITHUB_REF_NAME"
            exit 1
          fi

          VERSION="${GITHUB_REF_NAME#v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "âœ“ Valid version: $VERSION"

      - name: ðŸ§° Setup Expo/EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ”§ Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: ðŸ”¢ Sync app.json and package.json version to tag
        run: |
          node -e '
          const fs = require("fs");
          const version = process.env.VERSION;
          // derive numeric code from semver: major*10000 + minor*100 + patch
          const m = version.match(/^(\d+)\.(\d+)\.(\d+)/);
          if (!m) { throw new Error(`Invalid semver: ${version}`); }
          const [_, maj, min, pat] = m;
          const code = (+maj)*10000 + (+min)*100 + (+pat);
          const updateJSON = (file, path, setFn) => {
            const json = JSON.parse(fs.readFileSync(file, "utf8"));
            setFn(json);
            fs.writeFileSync(file, JSON.stringify(json, null, 2) + "\n");
            console.log(`Updated ${file}`);
          };
          updateJSON("package.json", [], (j) => { j.version = version; });
          updateJSON("app.json", ["expo","version"], (j) => {
            if(!j.expo) j.expo = {};
            j.expo.version = version;
            j.expo.ios = j.expo.ios || {};
            j.expo.ios.buildNumber = String(code);
            j.expo.android = j.expo.android || {};
            j.expo.android.versionCode = code;
          });
          '
          cat package.json | head -n 20
          cat app.json | head -n 40

      - name: ðŸ—ï¸ Build Android (production-apk)
        id: build_android
        run: |
          eas build --non-interactive --platform android --profile production-apk --wait --json > android_build.json
          cat android_build.json
          ANDROID_BUILD_ID=$(cat android_build.json | jq -r '.[0].id // .id // empty')
          if [ -z "$ANDROID_BUILD_ID" ] || [ "$ANDROID_BUILD_ID" = "null" ]; then
            echo "Error: Failed to extract Android build ID from EAS response"
            cat android_build.json
            exit 1
          fi
          echo "ANDROID_BUILD_ID=$ANDROID_BUILD_ID" >> $GITHUB_ENV
          
          echo "## ðŸ—ï¸ Android Build" >> $GITHUB_STEP_SUMMARY
          echo "- Build ID: $ANDROID_BUILD_ID" >> $GITHUB_STEP_SUMMARY
          echo "- Profile: production-apk" >> $GITHUB_STEP_SUMMARY
          echo "- Status: âœ… Success" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¥ Download Android APK
        run: |
          FNAME="Open-WebUI-Client-${VERSION}-android.apk"
          ID="$ANDROID_BUILD_ID"
          echo "Resolving Android artifact URL for $ID"
          
          for i in {1..3}; do
            echo "Attempt $i to fetch build details..."
            # Try JSON format
            if eas build:view "$ID" --json > android_view_raw.json 2>&1; then
              # Robust extraction from first { to last } using node
              node -e "const fs=require('fs');const s=fs.readFileSync(0,'utf8');const i=s.indexOf('{'),j=s.lastIndexOf('}');if(i>=0&&j>=0)console.log(s.substring(i,j+1))" < android_view_raw.json > android_view.json
              if jq empty android_view.json 2>/dev/null; then
                echo "Valid JSON extracted"
                break
              fi
            fi

            # Try text format parsing
            if eas build:view "$ID" > android_view_text.txt 2>&1; then
              URL=$(grep "^Artifact" android_view_text.txt | awk '{print $2}')
              if [ -n "$URL" ]; then
                echo "{\"artifacts\":{\"buildUrl\":\"$URL\"}}" > android_view.json
                echo "Extracted URL from text: $URL"
                break
              fi
            fi

            # Last resort: Direct API call
            if [ $i -eq 3 ]; then
              echo "Trying direct API call as last resort..."
              curl -H "Authorization: Bearer ${{ secrets.EXPO_TOKEN }}" \
                   -H "Accept: application/json" \
                   "https://api.expo.dev/v2/builds/$ID" > android_view.json
            fi

            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done

          # Check if android_view.json has valid content
          if [ ! -s android_view.json ] || ! jq empty android_view.json 2>/dev/null; then
            echo "Failed to fetch valid build details after 3 attempts"
            cat android_view_raw.json 2>/dev/null || echo "No raw output"
            exit 1
          fi

          URL=$(jq -r ".artifacts.buildUrl // 
                        .artifacts.applicationArchiveUrl // 
                        .artifacts.appBuildUrl // 
                        .data.artifacts.buildUrl // 
                        .data.artifacts.applicationArchiveUrl // 
                        .data.artifacts.appBuildUrl // 
                        empty" android_view.json)
          
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "Could not resolve Android artifact URL from JSON, checking text fallback..."
            if [ -f android_view_text.txt ]; then
              URL=$(grep "^Artifact" android_view_text.txt | awk '{print $2}')
            fi
          fi

          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "Error: Could not resolve Android artifact URL"
            cat android_view.json
            exit 1
          fi
          
          echo "Downloading $URL -> $FNAME"
          if curl -L "$URL" -o "$FNAME"; then
            echo "Download successful. File size: $(du -h "$FNAME" | cut -f1)"
            echo "ANDROID_APK=$FNAME" >> $GITHUB_ENV
          else
            echo "Download failed"
            exit 1
          fi

      - name: ðŸ—ï¸ Build iOS (ios-internal)
        id: build_ios
        continue-on-error: true
        run: |
          if eas build --non-interactive --platform ios --profile ios-internal --wait --json > ios_build.json; then
            cat ios_build.json
            IOS_BUILD_ID=$(cat ios_build.json | jq -r '.[0].id // .id // empty')
            if [ -n "$IOS_BUILD_ID" ] && [ "$IOS_BUILD_ID" != "null" ]; then
              echo "IOS_BUILD_ID=$IOS_BUILD_ID" >> $GITHUB_ENV
              echo "## ðŸ—ï¸ iOS Build" >> $GITHUB_STEP_SUMMARY
              echo "- Build ID: $IOS_BUILD_ID" >> $GITHUB_STEP_SUMMARY
              echo "- Profile: ios-internal" >> $GITHUB_STEP_SUMMARY
              echo "- Status: âœ… Success" >> $GITHUB_STEP_SUMMARY
            else
              echo "Failed to extract iOS build ID"
              exit 1
            fi
          else
            echo "iOS build command failed. This is expected if Apple credentials are not configured."
            echo "## ðŸ—ï¸ iOS Build" >> $GITHUB_STEP_SUMMARY
            echo "- Status: âš ï¸ Skipped or Failed (Check logs if this was unexpected)" >> $GITHUB_STEP_SUMMARY
            exit 0 # Make it "success" so workflow continues but IOS_BUILD_ID is not set
          fi

      - name: ðŸ“¥ Download iOS IPA
        if: env.IOS_BUILD_ID != '' && env.IOS_BUILD_ID != 'null'
        run: |
          FNAME="Open-WebUI-Client-${VERSION}-ios.ipa"
          ID="$IOS_BUILD_ID"
          echo "Resolving iOS artifact URL for $ID"
          
          for i in {1..3}; do
            echo "Attempt $i to fetch build details..."
            # Try JSON format
            if eas build:view "$ID" --json > ios_view_raw.json 2>&1; then
              # Robust extraction from first { to last } using node
              node -e "const fs=require('fs');const s=fs.readFileSync(0,'utf8');const i=s.indexOf('{'),j=s.lastIndexOf('}');if(i>=0&&j>=0)console.log(s.substring(i,j+1))" < ios_view_raw.json > ios_view.json
              if jq empty ios_view.json 2>/dev/null; then
                echo "Valid JSON extracted"
                break
              fi
            fi

            # Try text format parsing
            if eas build:view "$ID" > ios_view_text.txt 2>&1; then
              URL=$(grep "^Artifact" ios_view_text.txt | awk '{print $2}')
              if [ -n "$URL" ]; then
                echo "{\"artifacts\":{\"buildUrl\":\"$URL\"}}" > ios_view.json
                echo "Extracted URL from text: $URL"
                break
              fi
            fi

            # Last resort: Direct API call
            if [ $i -eq 3 ]; then
              echo "Trying direct API call as last resort..."
              curl -H "Authorization: Bearer ${{ secrets.EXPO_TOKEN }}" \
                   -H "Accept: application/json" \
                   "https://api.expo.dev/v2/builds/$ID" > ios_view.json
            fi

            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done

          # Check if ios_view.json has valid content
          if [ ! -s ios_view.json ] || ! jq empty ios_view.json 2>/dev/null; then
            echo "Failed to fetch valid build details after 3 attempts"
            cat ios_view_raw.json 2>/dev/null || echo "No raw output"
            exit 1
          fi

          URL=$(jq -r ".artifacts.buildUrl // 
                        .artifacts.applicationArchiveUrl // 
                        .artifacts.appBuildUrl // 
                        .data.artifacts.buildUrl // 
                        .data.artifacts.applicationArchiveUrl // 
                        .data.artifacts.appBuildUrl // 
                        empty" ios_view.json)
          
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "Could not resolve iOS artifact URL from JSON, checking text fallback..."
            if [ -f ios_view_text.txt ]; then
              URL=$(grep "^Artifact" ios_view_text.txt | awk '{print $2}')
            fi
          fi

          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "Error: Could not resolve iOS artifact URL"
            cat ios_view.json
            exit 1
          fi
          
          echo "Downloading $URL -> $FNAME"
          if curl -L "$URL" -o "$FNAME"; then
            echo "Download successful. File size: $(du -h "$FNAME" | cut -f1)"
            echo "IOS_IPA=$FNAME" >> $GITHUB_ENV
          else
            echo "Download failed"
            exit 1
          fi

      - name: ðŸš€ Submit iOS to TestFlight (optional)
        if: ${{ env.IOS_BUILD_ID != '' && env.IOS_BUILD_ID != 'null' }}
        run: |
          echo "Attempting TestFlight submission for build $IOS_BUILD_ID"
          if eas submit --platform ios --latest --non-interactive; then
            echo "TestFlight submission succeeded"
          else
            echo "âš ï¸ TestFlight submission failed or not configured"
            echo "This is expected if App Store Connect credentials are not set up"
          fi
        continue-on-error: true

      - name: ðŸ” Checksums
        run: |
          echo "Generating SHA256 checksums"
          shasum -a 256 "$ANDROID_APK" > SHA256SUMS.txt
          if [ -n "$IOS_IPA" ] && [ -f "$IOS_IPA" ]; then
            shasum -a 256 "$IOS_IPA" >> SHA256SUMS.txt
          fi

      - name: ðŸ“ Generate Release Notes
        id: notes
        run: |
          VERSION=${VERSION}
          TAG=${GITHUB_REF_NAME}
          PREV_TAG=$(git describe --tags --abbrev=0 --match 'v*' ${TAG}^ 2>/dev/null || echo '')
          echo "Previous tag: $PREV_TAG"
          if [ -n "$PREV_TAG" ]; then
            RANGE="$PREV_TAG..$TAG"
          else
            RANGE="$TAG"
          fi
          echo "Range: $RANGE"

          echo "# Open-WebUI-Client ${VERSION}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## Downloads" >> RELEASE_NOTES.md
          echo "- Android APK: ${ANDROID_APK}" >> RELEASE_NOTES.md
          if [ -n "$IOS_IPA" ] && [ -f "$IOS_IPA" ]; then
            echo "- iOS IPA (for internal/sideload testing): ${IOS_IPA}" >> RELEASE_NOTES.md
          fi
          if [ -n "${{ secrets.TESTFLIGHT_PUBLIC_LINK }}" ]; then
            echo "- TestFlight: ${{ secrets.TESTFLIGHT_PUBLIC_LINK }}" >> RELEASE_NOTES.md
          else
            echo "- TestFlight: Will appear once public link is available (configure TESTFLIGHT_PUBLIC_LINK secret to include automatically)." >> RELEASE_NOTES.md
          fi
          echo "" >> RELEASE_NOTES.md
          echo "## Checksums" >> RELEASE_NOTES.md
          cat SHA256SUMS.txt >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## Changes" >> RELEASE_NOTES.md
          if [ -n "$PREV_TAG" ]; then
            git log --pretty=format:'- %s (%h)' $RANGE >> RELEASE_NOTES.md
          else
            git log --pretty=format:'- %s (%h)' $TAG >> RELEASE_NOTES.md
          fi
          echo "" >> RELEASE_NOTES.md

      - name: ðŸ“¦ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Open-WebUI-Client ${{ env.VERSION }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
          files: |
            ${{ env.ANDROID_APK }}
            ${{ env.IOS_IPA }}
            SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ§¾ Ensure and update CHANGELOG.md
        run: |
          VERSION=${VERSION}
          DATE=$(date +%Y-%m-%d)
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "All notable changes to this project will be documented in this file." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          echo "" >> CHANGELOG.md
          echo "## [${VERSION}] - ${DATE}" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### Added/Changed" >> CHANGELOG.md
          if git rev-parse -q --verify refs/tags/${GITHUB_REF_NAME}^ >/dev/null; then
            PREV_TAG=$(git describe --tags --abbrev=0 --match 'v*' ${GITHUB_REF_NAME}^ 2>/dev/null || echo '')
          else
            PREV_TAG=""
          fi
          if [ -n "$PREV_TAG" ]; then
            git log --pretty=format:'- %s (%h)' $PREV_TAG..$GITHUB_REF_NAME >> CHANGELOG.md
          else
            git log --pretty=format:'- %s (%h)' $GITHUB_REF_NAME >> CHANGELOG.md
          fi

      - name: ðŸ§¹ Clean up old release branch
        run: |
          BRANCH="chore/release-${{ env.VERSION }}"
          if git ls-remote --exit-code --heads origin "$BRANCH"; then
            echo "Deleting existing branch $BRANCH"
            git push origin --delete "$BRANCH" || true
          fi

      - name: ðŸ§¾ Open PR to update CHANGELOG.md and versions
        uses: peter-evans/create-pull-request@v6
        continue-on-error: true
        with:
          base: main
          commit-message: "chore(release): ${{ env.VERSION }} version + changelog"
          title: "chore(release): ${{ env.VERSION }} version + changelog"
          body: "Automated version bump in app.json/package.json and CHANGELOG.md for ${{ env.VERSION }}"
          branch: chore/release-${{ env.VERSION }}
          add-paths: |
            CHANGELOG.md
            app.json
            package.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“‹ Diagnostic Info on Failure
        if: failure()
        run: |
          echo "## ðŸ” Failure Diagnostics" >> $GITHUB_STEP_SUMMARY
          echo "### Build artifacts:" >> $GITHUB_STEP_SUMMARY
          ls -lah *.json *.txt 2>/dev/null | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "No artifacts found" >> $GITHUB_STEP_SUMMARY
          echo "### Environment variables:" >> $GITHUB_STEP_SUMMARY
          env | grep -E "(BUILD_ID|VERSION|APK|IPA)" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "No relevant env vars" >> $GITHUB_STEP_SUMMARY
          echo "### EAS CLI version:" >> $GITHUB_STEP_SUMMARY
          eas --version >> $GITHUB_STEP_SUMMARY || echo "EAS CLI not installed" >> $GITHUB_STEP_SUMMARY
